{{- if .Values.grafanaDashboard.enabled }}
{{- $app := include "ecommerce-lite.name" . -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ecommerce-lite.fullname" . }}-dashboard
  labels:
    grafana_dashboard: "1"
    app: {{ include "ecommerce-lite.name" . }}
data:
  ecommerce-lite-dashboard.json: |
    {
      "title": "Ecommerce Lite",
      "timezone": "browser",
      "schemaVersion": 36,
      "version": 1,
      "panels": [
        {
          "type": "timeseries",
          "title": "HTTP Request Duration (p95)",
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{app=\"{{ $app }}\"}[5m])) by (le))"
            }
          ]
        },
        {
          "type": "stat",
          "title": "Requests Per Second",
          "targets": [
            {
              "expr": "sum(rate(http_request_duration_seconds_count{app=\"{{ $app }}\"}[1m]))"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Homepage Views / min",
          "targets": [
            {
              "expr": "sum(rate(ecommerce_page_views_total{app=\"{{ $app }}\"}[1m]))"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Add To Cart / min",
          "targets": [
            {
              "expr": "sum(rate(ecommerce_add_to_cart_total{app=\"{{ $app }}\"}[1m]))"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Checkout Value (p95)",
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum(rate(ecommerce_checkout_value_bucket{app=\"{{ $app }}\"}[5m])) by (le))"
            }
          ]
        },
        {
          "type": "stat",
          "title": "Last Checkout Items",
          "targets": [
            {
              "expr": "max(ecommerce_checkout_items_last{app=\"{{ $app }}\"})"
            }
          ]
        }
      ]
    }
{{- end }}
